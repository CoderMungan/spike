<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://spike.ist/main.css">
    <link rel="icon" href="https://spike.ist/assets/spike-favicon-16x16.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>  | ADR-0017: Synchronous Persistence for SPIKE Secrets Store </title>
</head>
<body>

<script>
        fetch('https://api.github.com/repos/spiffe/spike/releases/latest')
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                let release_name = data.name;
                let html_url = data.html_url;
                release.innerHTML = `<a href='${html_url}'>${release_name}</a>`;
            });
    </script>
<main>
    
    <nav>
            <h1><a href="https:&#x2F;&#x2F;spike.ist&#x2F;"></a></h1>
            <div id="release"></div>
            <a href="javascript:void(0);" onclick="burger()" id="mobile" class="ms-Icon--GlobalNavButton"></a>
            <div id="trees">
                <input class="tree-toggle" type="checkbox" id="getting-started"
                           />
                    <label class="tree-toggle-label"
                           for="getting-started">Getting Started</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/getting-started/guide/">Quickstart</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/getting-started/alpha-release-notice/">Alpha Release Notice</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/getting-started/configuration/">Configuring SPIKE</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="community"
                           />
                    <label class="tree-toggle-label"
                           for="community">Community</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/community/hello/">Hello Universe</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/community/contact/">Contact Us</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/community/presentations/">Presentations and Demos</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="spike-architecture"
                           checked/>
                    <label class="tree-toggle-label"
                           for="spike-architecture">SPIKE Architecture</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/architecture/system-overview/">System Overview</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/architecture/security-model/">SPIKE Security Model</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/architecture/architectural-decision-records/">ADRs</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="tracking"
                           />
                    <label class="tree-toggle-label"
                           for="tracking">Tracking</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/tracking/changelog/">Changelog</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/tracking/snapshots/">Documentation Snapshots</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="operations"
                           />
                    <label class="tree-toggle-label"
                           for="operations">Operations</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/operations/build/">SPIKE Cross-Platform Build</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/operations/production/">SPIKE Production Setup</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/operations/recovery/">SPIKE Recovery Procedures</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/operations/release/">SPIKE Relase Management</a>
                            </li>

                            </ul>
                </div>
        </nav>
    <article>



        <div id="on_right">
                <span id="search-ico" class="ms-Icon--Search"></span>
            </div>
            <div class="search-container">
                <input id="search" type="search" placeholder="Search as you type...">
                <div class="search-results">
                    <div class="search-results__header"></div>
                    <ul class="search-results__items"></ul>
                </div>
            </div>
        <p style="background:#ffffff;text-align:center;padding:1em;
max-width: 800px;margin: 0 auto;
border-radius: 6px;margin-bottom: -0.5em;
padding-bottom: 1.5em;
box-shadow: rgba(0, 0, 0, 0.2) 0px 18px 50px -10px;
">
            Pssst... <a href="https://github.com/spiffe/spike"
        style="border-bottom: 2px solid #07bdd9"
        ><strong>‚≠êÔ∏è
            Star SPIKE on GitHub ‚≠êÔ∏è</strong></a>.<br>
            Spread the word about this amazing technology üê¢‚ö°Ô∏è.
        </p>


        <div id="wrap">
             
        <p><a href="/docs-src/public" title="Back to home"><img src="/docs/assetsssets/spike-banner.png"
                                                                style="float:left;margin: 0 1em 0 1em;" alt="SPIKE Logo" /></a></p>
<h1 id="adr-0017-synchronous-persistence-for-spike-secrets-store">ADR-0017: Synchronous Persistence for SPIKE Secrets Store</h1>
<br style="clear:both" />
<ul>
<li>Status: accepted</li>
<li>Date: 2025-01-25</li>
<li>Tags: Security, Persistence, Database, Backing-Store, Performance</li>
</ul>
<h2 id="context">Context</h2>
<p><strong>SPIKE</strong> is a secrets store that can use a SQLite backing store (<em>among other
backing store options</em>) to persist secrets. However, the source of truth for
the secrets is held in memory. SQLite is primarily used as a backup to rehydrate
secrets in case the secrets store crashes or needs to be recovered.</p>
<p>Persistence operations were initially designed to be asynchronous, using methods
like <code>AsyncSaveSecret()</code>, to minimize blocking and improve performance. However,
this design has introduced unnecessary complexity, race conditions, and edge
cases, with no significant benefit to the overall system. SQLite, being fast and
lightweight, already offers sufficient performance without the need for
additional asynchronous operations.</p>
<h2 id="problem">Problem</h2>
<p>The asynchronous approach to persistence introduces the following issues:</p>
<ul>
<li><strong>Increased complexity</strong>: Asynchronous operations, while designed to improve
performance, add complexity to the system, making it harder to reason about
and troubleshoot.</li>
<li><strong>Race conditions and edge cases</strong>: The asynchronous operations have led to
potential race conditions, which compromise the system‚Äôs reliability.</li>
<li><strong>Debugging difficulty</strong>: To avoid the race conditions above, we could have
use abstractions, including Go channels. However, using Go channels and
asynchronous operations creates challenges for debugging, as tracking state
transitions becomes non-trivial.</li>
</ul>
<p>Given that SQLite is already fast enough for our needs, the performance benefit
of using asynchronous operations is minimal. As a result, we no longer see a
significant justification for using asynchronous persistence operations in
this context.</p>
<h2 id="decision">Decision</h2>
<ul>
<li>
<p><strong>Synchronous Persistence</strong>: All database persistence operations will now be
synchronous.</p>
<ul>
<li><strong>Justification</strong>: Since SQLite is sufficiently fast, and we are not seeing
performance bottlenecks at the database level, the simplicity of synchronous
operations outweighs the potential complexity of maintaining asynchronous
ones.</li>
<li><strong>Expected Outcome</strong>: This decision reduces the complexity of the codebase,
eliminates the potential for race conditions, and makes the system easier
to debug and maintain. We will continue to monitor for any performance
impact that might arise due to this decision.</li>
</ul>
</li>
<li>
<p><strong>Fallback to Async if Performance Issues Arise</strong>: In the unlikely event that
we observe significant performance issues with synchronous operations, we
will consider optimizing specific areas locally.</p>
<ul>
<li><strong>Optimization Strategy</strong>: If performance degradation is observed, we will
explore optimization options such as local caching, batching of persistence
operations, or fine-tuning SQLite settings. Asynchronous operations may be
reintroduced selectively in these cases.</li>
</ul>
</li>
</ul>
<h2 id="consequences">Consequences</h2>
<ul>
<li><strong>Reduced Complexity</strong>: By removing asynchronous operations, the system will
be simpler and easier to maintain, with fewer edge cases and race conditions
to handle.</li>
<li><strong>Performance Tradeoff</strong>: Synchronous operations may result in slight
performance degradation if there is a heavy load on the persistence layer.
However, this is unlikely given the current design and SQLite‚Äôs speed.</li>
<li><strong>Easier Debugging</strong>: The synchronous model simplifies debugging, as there are
no concurrent operations that need to be tracked.</li>
</ul>
<h2 id="alternatives-considered">Alternatives Considered</h2>
<ul>
<li><strong>Async Persistence</strong>: We initially considered keeping asynchronous operations
to prevent blocking and improve performance. However, this would introduce
complexity that isn‚Äôt justified by the system‚Äôs current requirements and
SQLite‚Äôs speed.</li>
<li><strong>Go Channels for Sync Operations</strong>: Using Go channels to handle
synchronization in asynchronous operations was also considered, but it would
increase debugging complexity and not address the core issue effectively.</li>
</ul>
<hr />
<p>This ADR will be revisited if performance issues arise, but for now, the shift
to synchronous persistence aligns with the goal of simplifying the codebase and
improving system stability.</p>
<hr />
<ul>
<li><a href="https://spike.ist/architecture/adrs/adr-0017/">ADR-0017: Synchronous Persistence for SPIKE Secrets Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0016/">ADR-0016: Memory-First Secrets Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0015/">ADR-0015: Use Singular Form for File and Package Naming</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0014/">ADR-0014: Maintaining SQLite as SPIKE‚Äôs Primary Storage Backend</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0013/">ADR-0013: S3-Compatible Storage as SPIKE‚Äôs Backing Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0012/">ADR-0012: HTTP Methods for SPIKE API</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0011/">ADR-0011: PostgreSQL as SPIKE‚Äôs Backing Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0010/">ADR-0010: Session Token Storage Strategy for SPIKE Nexus</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0009/">ADR-0009: Multi-Administrator Support System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0008/">ADR-0008: Administrative Access Control System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0007/">ADR-0007: Root Key Lifecycle and Management Strategy</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0006/">ADR-0006: Trust Boundary Definition and Security Assumptions</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0005/">ADR-0005: Use SPIFFE mTLS for Inter-Component Authentication and Communication</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0004/">ADR-0004: SPIKE Keeper Minimalist Design Approach</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0003/">ADR-0003: Root Key Management and Storage Strategy</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0002/">ADR-0002: Use Docsify for Documentation System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0001/">ADR-0001: Display Secrets in Plain Text in SPIKE Pilot Admin CLI</a></li>
</ul>
<hr />
<ul>
<li><a href="https://spike.ist/architecture/system-overview/"><strong>SPIKE</strong> System Overview</a></li>
<li><a href="https://spike.ist/architecture/security-model/"><strong>SPIKE</strong> Security Model</a></li>
<li><a href="https://spike.ist/architecture/architectural-decision-records/"><strong>SPIKE</strong> Architectural Decision Records</a></li>
</ul>

    

        </div>
        <footer style="padding:1em;padding-top:1em;padding-bottom:1em;
font-size: 14px;
margin-top: 2em;
max-width: 550px;
margin: 2em auto;
" id="footer">

            Copyright ¬© 2024-present <strong>SPIKE Contributors</strong>.<br>
            <strong>SPIKE</strong>'s code
            is distributed under <a class="text-blue-600 underline" href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License (v2.0)</a>.
            <br>
            The documentation on this website
            is distributed under <a class="text-blue-600 underline" href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>.
            <br><br>
            We <strong>do not</strong> collect your data.
            This site <strong>does not</strong> use any tracking cookies or scripts.
        </footer>



    </article>

</main>


    <script type="text/javascript" src="https://spike.ist/elasticlunr.min.js" defer></script>
    <script type="text/javascript" src="https://spike.ist/search_index.en.js" defer></script>
<script type="text/javascript" src="https://spike.ist/js.js" defer></script>
</body>
</html>
