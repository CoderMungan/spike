<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://spike.ist/main.css">
    <link rel="icon" href="https://spike.ist/assets/spike-favicon-16x16.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>  | ADR-0013: S3-Compatible Storage as SPIKE&#x27;s Backing Store </title>
</head>
<body>

<script>
        fetch('https://api.github.com/repos/spiffe/spike/releases/latest')
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                let release_name = data.name;
                let html_url = data.html_url;
                release.innerHTML = `<a href='${html_url}'>${release_name}</a>`;
            });
    </script>
<main>
    
    <nav>
            <h1><a href="https:&#x2F;&#x2F;spike.ist&#x2F;"></a></h1>
            <div id="release"></div>
            <a href="javascript:void(0);" onclick="burger()" id="mobile" class="ms-Icon--GlobalNavButton"></a>
            <div id="trees">
                <input class="tree-toggle" type="checkbox" id="getting-started"
                           />
                    <label class="tree-toggle-label"
                           for="getting-started">Getting Started</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/getting-started/guide/">Quickstart</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/getting-started/alpha-release-notice/">Alpha Release Notice</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/getting-started/configuration/">Configuring SPIKE</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="community"
                           />
                    <label class="tree-toggle-label"
                           for="community">Community</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/community/hello/">Hello Universe</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/community/contact/">Contact Us</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/community/presentations/">Presentations and Demos</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="spike-architecture"
                           checked/>
                    <label class="tree-toggle-label"
                           for="spike-architecture">SPIKE Architecture</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/architecture/system-overview/">System Overview</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/architecture/security-model/">SPIKE Security Model</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/architecture/architectural-decision-records/">ADRs</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="tracking"
                           />
                    <label class="tree-toggle-label"
                           for="tracking">Tracking</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/tracking/changelog/">Changelog</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/tracking/snapshots/">Documentation Snapshots</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="operations"
                           />
                    <label class="tree-toggle-label"
                           for="operations">Operations</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://spike.ist/operations/build/">SPIKE Cross-Platform Build</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/operations/production/">SPIKE Production Setup</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/operations/recovery/">SPIKE Recovery Procedures</a>
                            </li>

                            <li >
                                <a href="https://spike.ist/operations/release/">SPIKE Relase Management</a>
                            </li>

                            </ul>
                </div>
        </nav>
    <article>



        <div id="on_right">
                <span id="search-ico" class="ms-Icon--Search"></span>
            </div>
            <div class="search-container">
                <input id="search" type="search" placeholder="Search as you type...">
                <div class="search-results">
                    <div class="search-results__header"></div>
                    <ul class="search-results__items"></ul>
                </div>
            </div>
        <p style="background:#ffffff;text-align:center;padding:1em;
max-width: 800px;margin: 0 auto;
border-radius: 6px;margin-bottom: -0.5em;
padding-bottom: 1.5em;
box-shadow: rgba(0, 0, 0, 0.2) 0px 18px 50px -10px;
">
            Pssst... <a href="https://github.com/spiffe/spike"
        style="border-bottom: 2px solid #07bdd9"
        ><strong>‚≠êÔ∏è
            Star SPIKE on GitHub ‚≠êÔ∏è</strong></a>.<br>
            Spread the word about this amazing technology üê¢‚ö°Ô∏è.
        </p>


        <div id="wrap">
             
        <p><a href="/docs-src/public" title="Back to home"><img src="/docs/assetsssets/spike-banner.png"
                                                                style="float:left;margin: 0 1em 0 1em;" alt="SPIKE Logo" /></a></p>
<h1 id="adr-0013-s3-compatible-storage-as-spike-s-backing-store">ADR-0013: S3-Compatible Storage as SPIKE‚Äôs Backing Store</h1>
<br style="clear:both" />
<ul>
<li>Status:
<ul>
<li>accepted</li>
<li>Superseeds <a href="https://spike.ist/architecture/adrs/adr-0013/adrs/adr-0011.md">ADR-0011: PostgreSQL as SPIKE‚Äôs Backing Store</a></li>
</ul>
</li>
<li>Date: 2024-11-07</li>
<li>Tags: Storage, Authorization, Policy, S3, MinIO</li>
</ul>
<ul>
<li>in-memory: for dev environments</li>
<li>sqlite as the default backing store (will come by default)</li>
<li>plugin for postgres</li>
<li>plugin for S3</li>
<li>instructions to create your own plugin</li>
</ul>
<h2 id="context">Context</h2>
<p>SPIKE needs a reliable, secure, and performant backing store to maintain encrypted
data including:</p>
<ul>
<li>Root keys (<em>encrypted with admin password</em>)</li>
<li>Admin tokens (<em>encrypted with root key</em>)</li>
<li>Secrets (<em>encrypted with root key</em>)</li>
</ul>
<p>The system requires:</p>
<ul>
<li>Secure storage of encrypted blobs</li>
<li>Path-based access control</li>
<li>Audit logging capabilities</li>
<li>Flexible deployment options (<em>cloud and on-premises</em>)</li>
<li>Integration with existing identity providers</li>
</ul>
<p>After further analysis, we recognized that our secrets storage model closely
resembles object storage patterns, where:</p>
<ul>
<li>Secrets are essentially encrypted blobs</li>
<li>Access is path-based</li>
<li>Authorization decisions are made at the path level</li>
<li>Storage and retrieval operations are simple CRUD operations</li>
</ul>
<h2 id="decision">Decision</h2>
<p>We will use S3-compatible storage systems (<em>AWS S3, MinIO</em>) as the backing
store for SPIKE, leveraging their native policy engines for access control.</p>
<h2 id="rationale">Rationale</h2>
<h3 id="authorization-model">Authorization Model</h3>
<ul>
<li>S3‚Äôs IAM/policy engine is battle-tested and well-understood</li>
<li>Path-based policies align perfectly with SPIKE‚Äôs access patterns</li>
<li>Eliminates need to build and maintain a custom policy framework</li>
<li>Policies can be managed through existing tools and processes</li>
</ul>
<h3 id="storage-capabilities">Storage Capabilities</h3>
<ul>
<li>Excellent for blob storage (<em>our encrypted secrets</em>)</li>
<li>Strong consistency guarantees (<em>especially with newer S3 versions</em>)</li>
<li>Built-in versioning support</li>
<li>Cross-region replication options</li>
<li>Excellent scalability characteristics</li>
</ul>
<h3 id="operational-benefits">Operational Benefits</h3>
<ul>
<li>Multiple implementation options:
<ul>
<li>AWS S3 for cloud deployments</li>
<li>MinIO for on-premises deployments</li>
<li>Other S3-compatible systems for special cases</li>
</ul>
</li>
<li>Rich ecosystem of tools and utilities</li>
<li>Robust backup and lifecycle management</li>
<li>Built-in metrics and monitoring</li>
<li>Cost-effective for our access patterns</li>
</ul>
<h3 id="security-features">Security Features</h3>
<ul>
<li>Native encryption at rest</li>
<li>SSL/TLS support</li>
<li>Integration with various identity providers</li>
<li>Built-in audit logging</li>
<li>Object versioning for recovery</li>
</ul>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<ul>
<li>Simplified architecture by using storage system‚Äôs native policy engine</li>
<li>Reduced code complexity in SPIKE</li>
<li>Better separation of concerns (<em>storage/policy vs. application logic</em>)</li>
<li>Flexibility in deployment options (<em>cloud or on-prem</em>)</li>
<li>Future-proof: Can adopt better policy engines (<em>e.g., OPA</em>) without changing
storage layer</li>
<li>Built-in versioning and audit capabilities</li>
</ul>
<h3 id="negative">Negative</h3>
<ul>
<li>Dependent on S3 API compatibility</li>
<li>May need to implement additional caching layer for performance</li>
<li>Limited by S3‚Äôs eventual consistency model for some operations</li>
<li>Need to ensure policy engine capabilities are consistent across different
S3 implementations</li>
</ul>
<h3 id="mitigations">Mitigations</h3>
<ul>
<li>Implement abstraction layer to handle S3 implementation differences</li>
<li>Document consistency requirements and guarantees</li>
<li>Regular testing with different S3-compatible systems</li>
</ul>
<h2 id="implementation-notes">Implementation Notes</h2>
<h3 id="storage-pattern">Storage Pattern</h3>
<ul>
<li>Memory is the <strong>primary</strong> storage medium</li>
<li>S3 serves dual purposes:
<ul>
<li>Authorization source (<em>via IAM/policies</em>)</li>
<li>Persistent backup store</li>
</ul>
</li>
<li>Write pattern:
<ul>
<li>Check S3 policy authorization</li>
<li>If authorized, write to memory</li>
<li>Asynchronously write to S3 for persistence</li>
</ul>
</li>
<li>Read pattern:
<ul>
<li>Check S3 policy authorization</li>
<li>If authorized, serve from memory</li>
<li>Only read from S3 during cold starts or recovery
<ul>
<li>for non-HA deployments</li>
<li>for HA deployments, the design will need to be adjusted</li>
</ul>
</li>
</ul>
</li>
<li>Delete pattern:
<ul>
<li>Check S3 policy authorization</li>
<li>If authorized, remove from memory</li>
<li>Mark as deleted in S3 (using versioning)</li>
</ul>
</li>
</ul>
<h3 id="storage-layer">Storage Layer</h3>
<ul>
<li>Use AWS SDK for S3 operations</li>
<li>Implement storage interface that can work with any S3-compatible system</li>
<li>Encrypt all data before storage</li>
<li>Use versioning for secret history</li>
</ul>
<h3 id="caching-strategy">Caching Strategy</h3>
<ul>
<li>Implement in-memory cache for performance</li>
<li>Cache only after confirming S3 permissions</li>
<li>Clear cache on policy changes</li>
<li>Implement TTL for cached items</li>
</ul>
<h3 id="policy-management">Policy Management</h3>
<ul>
<li>Use native S3 policy format</li>
<li>Document common policy patterns</li>
<li>Provide helper utilities for policy creation</li>
<li>Test policies across different S3 implementations</li>
</ul>
<h3 id="future-considerations">Future Considerations</h3>
<ul>
<li>If more complex policy requirements emerge, we can:
<ol>
<li>Continue using S3 for storage</li>
<li>Integrate OPA or similar for advanced policy evaluation</li>
<li>Keep existing S3 policies as coarse-grained control</li>
</ol>
</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-bucket-policy.html">AWS S3 Policy Documentation</a></li>
<li><a href="https://docs.min.io/docs/minio-security-guide.html">MinIO Security Guide</a></li>
<li><a href="https://www.openpolicyagent.org/docs/latest/">OPA (Open Policy Agent) Documentation</a></li>
</ul>
<h2 id="notes">Notes</h2>
<p>This approach keeps SPIKE lean and focused while leveraging battle-tested
components for storage and authorization. By using S3‚Äôs native policy engine
initially, we avoid premature optimization while maintaining the flexibility to
adopt more sophisticated policy engines like OPA if needed in the future.</p>
<hr />
<ul>
<li><a href="https://spike.ist/architecture/adrs/adr-0017/">ADR-0017: Synchronous Persistence for SPIKE Secrets Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0016/">ADR-0016: Memory-First Secrets Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0015/">ADR-0015: Use Singular Form for File and Package Naming</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0014/">ADR-0014: Maintaining SQLite as SPIKE‚Äôs Primary Storage Backend</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0013/">ADR-0013: S3-Compatible Storage as SPIKE‚Äôs Backing Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0012/">ADR-0012: HTTP Methods for SPIKE API</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0011/">ADR-0011: PostgreSQL as SPIKE‚Äôs Backing Store</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0010/">ADR-0010: Session Token Storage Strategy for SPIKE Nexus</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0009/">ADR-0009: Multi-Administrator Support System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0008/">ADR-0008: Administrative Access Control System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0007/">ADR-0007: Root Key Lifecycle and Management Strategy</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0006/">ADR-0006: Trust Boundary Definition and Security Assumptions</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0005/">ADR-0005: Use SPIFFE mTLS for Inter-Component Authentication and Communication</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0004/">ADR-0004: SPIKE Keeper Minimalist Design Approach</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0003/">ADR-0003: Root Key Management and Storage Strategy</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0002/">ADR-0002: Use Docsify for Documentation System</a></li>
<li><a href="https://spike.ist/architecture/adrs/adr-0001/">ADR-0001: Display Secrets in Plain Text in SPIKE Pilot Admin CLI</a></li>
</ul>
<hr />
<ul>
<li><a href="https://spike.ist/architecture/system-overview/"><strong>SPIKE</strong> System Overview</a></li>
<li><a href="https://spike.ist/architecture/security-model/"><strong>SPIKE</strong> Security Model</a></li>
<li><a href="https://spike.ist/architecture/architectural-decision-records/"><strong>SPIKE</strong> Architectural Decision Records</a></li>
</ul>

    

        </div>
        <footer style="padding:1em;padding-top:1em;padding-bottom:1em;
font-size: 14px;
margin-top: 2em;
max-width: 550px;
margin: 2em auto;
" id="footer">

            Copyright ¬© 2024-present <strong>SPIKE Contributors</strong>.<br>
            <strong>SPIKE</strong>'s code
            is distributed under <a class="text-blue-600 underline" href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License (v2.0)</a>.
            <br>
            The documentation on this website
            is distributed under <a class="text-blue-600 underline" href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>.
            <br><br>
            We <strong>do not</strong> collect your data.
            This site <strong>does not</strong> use any tracking cookies or scripts.
        </footer>



    </article>

</main>


    <script type="text/javascript" src="https://spike.ist/elasticlunr.min.js" defer></script>
    <script type="text/javascript" src="https://spike.ist/search_index.en.js" defer></script>
<script type="text/javascript" src="https://spike.ist/js.js" defer></script>
</body>
</html>
